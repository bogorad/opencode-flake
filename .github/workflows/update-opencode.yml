name: Update OpenCode

on:
  repository_dispatch:
    types: [opencode-release-detected]
  workflow_dispatch:
    inputs:
      version:
        description: Semver version to update to (optional)
        required: false

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Setup Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Install nix-update
        run: nix profile add nixpkgs#nix-update

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Step 1 - Update Version and Source Hash
        env:
          DISPATCH_VERSION: ${{ github.event.client_payload.version }}
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          set -euo pipefail

          VERSION="${INPUT_VERSION:-}"
          if [ -z "$VERSION" ]; then
            VERSION="${DISPATCH_VERSION:-}"
          fi
          if [ -z "$VERSION" ]; then
            VERSION=$(curl -sSfL https://api.github.com/repos/sst/opencode/releases/latest | jq -r '.tag_name // ""' | sed 's/^v//')
          fi
          if [ -z "$VERSION" ]; then
            echo "Failed to determine target version."
            exit 1
          fi
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Target version '$VERSION' is not a semantic version (x.y.z)."
            exit 1
          fi

          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "Using version $VERSION"

          nix-update --flake opencode --version "$VERSION" || true

          SRC_URL="https://github.com/sst/opencode/archive/refs/tags/v${VERSION}.tar.gz"
          BASE32=$(nix-prefetch-url --unpack "$SRC_URL" --type sha256)
          SRI=$(nix hash convert --hash-algo sha256 --to sri "$BASE32")
          sed -i -E "s|(hash = \")[^\"]*(\")|\\1$SRI\\2|" package.nix
          sed -i -E "s|(version = \")[^\"]*(\")|\\1$VERSION\\2|" package.nix

      - name: Step 2 - Fix Go Vendor Hash
        run: |
          echo "Setting dummy vendorHash..."
          DUMMY_VENDOR="sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
          sed -i -E "s|vendorHash = \"[^\"]*\"|vendorHash = \"$DUMMY_VENDOR\"|" package.nix

          echo "Building TUI to discover correct vendorHash..."
          BUILD_LOG=$(nix build .#opencode.tui --system x86_64-linux -L 2>&1) || true

          CORRECT_HASH=$(echo "$BUILD_LOG" | grep -oP 'got:\s+\Ksha256-[A-Za-z0-9+/=]+' | tail -1)

          if [ -z "$CORRECT_HASH" ]; then
            echo "Failed to extract vendorHash"
            echo "$BUILD_LOG" | tail -100
            exit 1
          fi

          sed -i -E "s|vendorHash = \"$DUMMY_VENDOR\"|vendorHash = \"$CORRECT_HASH\"|" package.nix
          echo "vendorHash updated: $CORRECT_HASH"

      - name: Step 3 - Fix node_modules x86_64-linux Output Hash
        run: |
          echo "Setting dummy x86_64-linux node_modules outputHash..."
          DUMMY="sha256-BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB="
          sed -i -E "s|(x86_64-linux = \")[^\"]*(\")|\\1$DUMMY\\2|" package.nix

          echo "Building node_modules to discover correct x86_64-linux outputHash..."
          BUILD_LOG=$(nix build .#opencode --system x86_64-linux -L 2>&1) || true

          CORRECT_HASH=$(echo "$BUILD_LOG" | grep -oP 'got:\s+\Ksha256-[A-Za-z0-9+/=]+' | head -1)

          if [ -z "$CORRECT_HASH" ]; then
            echo "Failed to extract x86_64-linux node_modules hash"
            echo "$BUILD_LOG" | tail -100
            exit 1
          fi

          sed -i -E "s|(x86_64-linux = \")[^\"]*(\")|\\1$CORRECT_HASH\\2|" package.nix
          echo "x86_64-linux node_modules hash updated: $CORRECT_HASH"

      - name: Step 4 - Fix node_modules aarch64-linux Output Hash
        run: |
          echo "Setting dummy aarch64-linux node_modules outputHash..."
          DUMMY="sha256-CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC="
          sed -i -E "s|(aarch64-linux = \")[^\"]*(\")|\\1$DUMMY\\2|" package.nix

          echo "Building node_modules to discover correct aarch64-linux outputHash..."
          BUILD_LOG=$(nix build .#opencode --system aarch64-linux -L 2>&1) || true

          CORRECT_HASH=$(echo "$BUILD_LOG" | grep -oP 'got:\s+\Ksha256-[A-Za-z0-9+/=]+' | head -1)

          if [ -z "$CORRECT_HASH" ]; then
            echo "Failed to extract aarch64-linux node_modules hash"
            echo "$BUILD_LOG" | tail -100
            exit 1
          fi

          sed -i -E "s|(aarch64-linux = \")[^\"]*(\")|\\1$CORRECT_HASH\\2|" package.nix
          echo "aarch64-linux node_modules hash updated: $CORRECT_HASH"

      - name: Step 5 - Verification Build
        run: |
          echo "Running final verification build for x86_64-linux..."
          nix build .#opencode --system x86_64-linux -L
          echo "Build successful."

      - name: Step 6 - Commit and Push Changes
        env:
          PERSONAL_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          DEFAULT_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          echo "Checking for changes to package.nix..."
          if git diff --quiet package.nix; then
            echo "No changes detected. Repository is already up to date."
            exit 0
          fi

          git add package.nix
          git commit -m "Update OpenCode to ${{ env.VERSION }}" \
            -m "Automated hash updates for all architectures"

          git tag -f "v${{ env.VERSION }}"

          TOKEN="$PERSONAL_TOKEN"
          if [ -z "$TOKEN" ]; then
            TOKEN="$DEFAULT_TOKEN"
          fi
          if [ -z "$TOKEN" ]; then
            echo "No token available for pushing changes."
            exit 1
          fi

          git config credential.helper store
          trap 'rm -f ~/.git-credentials' EXIT
          printf 'https://x-access-token:%s@github.com\n' "$TOKEN" > ~/.git-credentials

          git pull --rebase origin master
          git push origin HEAD:master
          git push -f origin "v${{ env.VERSION }}"

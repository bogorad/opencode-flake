--- a/packages/opencode/src/cli/cmd/tui/thread.ts
+++ b/packages/opencode/src/cli/cmd/tui/thread.ts
@@ -1,7 +1,6 @@
 import { cmd } from "@/cli/cmd/cmd"
 import { tui } from "./app"
-import { Rpc } from "@/util/rpc"
-import { type rpc } from "./worker"
+import { Server } from "../../../server/server"
 import { upgrade } from "@/cli/upgrade"
 import { Session } from "@/session"
 import { bootstrap } from "@/cli/bootstrap"
@@ -88,24 +87,9 @@
         return undefined
       })()
 
-      const worker = new Worker("./src/cli/cmd/tui/worker.ts", {
-        env: Object.fromEntries(
-          Object.entries(process.env).filter(
-            (entry): entry is [string, string] => entry[1] !== undefined,
-          ),
-        ),
-      })
-      worker.onerror = console.error
-      const client = Rpc.client<typeof rpc>(worker)
-      process.on("uncaughtException", (e) => {
-        console.error(e)
-      })
-      process.on("unhandledRejection", (e) => {
-        console.error(e)
-      })
-      const server = await client.call("server", {
-        port: args.port,
-        hostname: args.hostname,
+      const server = Server.listen({
+        port: args.port ?? 0,
+        hostname: args.hostname ?? "127.0.0.1",
       })
       await tui({
         url: server.url,
@@ -114,7 +98,8 @@
         agent: args.agent,
         prompt,
         onExit: async () => {
-          await client.call("shutdown", undefined)
+          await import("@/global").then((mod) => mod.Global.disposeAll())
+          server.stop()
         },
       })
     })
